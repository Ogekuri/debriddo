# WORKFLOW

- Feature: Application startup and lifecycle
  - Component: src/debriddo/main.py
    - `resolve_thread_count()`: Resolve thread pool size from N_THREADS or CPU heuristic. [src/debriddo/main.py, 116-135]
      - description: Reads N_THREADS, uses auto calculation when missing or "auto", logs parsing errors for invalid values, and falls back to 1 when invalid.
      - input: None
      - output: n_threads
      - calls:
        - `resolve_auto_thread_count()`: Calculate thread count from CPU with error fallback. [src/debriddo/main.py, 138-143]
          - description: Calls calculate_optimal_thread_count and returns 1 when the calculation raises an error, logging the failure.
          - input: None
          - output: n_threads
          - calls:
            - `calculate_optimal_thread_count()`: Calculate thread pool size from CPU cores. [src/debriddo/main.py, 101-113]
              - description: Reads os.cpu_count(), applies (cores*2)+1 heuristic, and raises if CPU core count is unavailable.
              - input: None
              - output: optimal_num_threads
    - `get_or_create_event_loop()`: Ensure an asyncio event loop is available. [src/debriddo/main.py, 146-152]
      - description: Retrieves the current event loop or creates and sets a new loop when missing.
      - input: None
      - output: loop: asyncio.AbstractEventLoop, default loop for executor setup
    - `lifespan()`: Configure scheduler and application lifecycle hooks. [src/debriddo/main.py, 155-175]
      - description: Starts APScheduler job for update checks, logs reload status, yields control, and shuts down scheduler on exit.
      - input: app
      - output: None
      - calls:
        - `update_app()`: Self-update check and in-place upgrade routine. [src/debriddo/main.py, 530-580]
          - description: Calls GitHub releases API, downloads zip when version differs, extracts and copies files, then deletes update artifacts.
          - input: None
          - output: None
          - calls:
            - `request_get()`: Issue HTTP GET with AsyncThreadSafeSession headers. [src/debriddo/utils/async_httpx_session.py, 124-125]
              - description: Wraps request() to perform HTTP GET via httpx client.
              - input: url; kwargs
              - output: response; None: None, on error
              - calls:
                - `request()`: Core HTTP request wrapper with error handling. [src/debriddo/utils/async_httpx_session.py, 98-122]
                  - description: Executes async HTTPX request with default headers/timeout and returns response or None on errors.
                  - input: method; url; kwargs
                  - output: response; None: None, on HTTP or connection errors
            - `close()`: Close AsyncThreadSafeSession client. [src/debriddo/utils/async_httpx_session.py, 41-45]
              - description: Closes the underlying HTTPX client and marks session closed.
              - input: None
              - output: None

- Feature: Request logging middleware
  - Component: src/debriddo/main.py
    - `__call__()`: Log HTTP requests with sanitized path and body. [src/debriddo/main.py, 183-215]
      - description: Builds Request, redacts config/query segments from path, logs method and body, and delegates to downstream app.
      - input: scope; receive; send
      - output: response

- Feature: Configuration UI and static assets
  - Component: src/debriddo/main.py
    - `root()`: Redirect root requests to configuration UI. [src/debriddo/main.py, 240-241]
      - description: Returns a RedirectResponse to /configure.
      - input: None
      - output: RedirectResponse: RedirectResponse, redirect to /configure
    - `configure()`: Render configuration UI HTML. [src/debriddo/main.py, 274-275]
      - description: Uses get_index to substitute application metadata into web/index.html.
      - input: None
      - output: index: str, HTML content
      - calls:
        - `get_index()`: Load index.html and replace UI placeholders. [src/debriddo/web/pages.py, 9-15]
          - description: Reads index.html from WEB_DIR and replaces $APP_NAME, $APP_VERSION, $APP_ENVIRONMENT.
          - input: app_name; app_version; app_environment
          - output: index: str, rendered HTML
    - `get_favicon()`: Serve favicon.ico asset. [src/debriddo/main.py, 244-247]
      - description: Returns FileResponse for WEB_DIR/images/favicon.ico.
      - input: None
      - output: response: FileResponse, favicon asset
    - `get_favicon()`: Serve config.js asset. [src/debriddo/main.py, 252-254]
      - description: Returns FileResponse for WEB_DIR/config.js.
      - input: None
      - output: response: FileResponse, config.js asset
    - `get_favicon()`: Serve lz-string.min.js asset. [src/debriddo/main.py, 259-261]
      - description: Returns FileResponse for WEB_DIR/lz-string.min.js.
      - input: None
      - output: response: FileResponse, lz-string asset
    - `get_favicon()`: Serve styles.css asset. [src/debriddo/main.py, 266-268]
      - description: Returns FileResponse for WEB_DIR/styles.css.
      - input: None
      - output: response: FileResponse, styles asset
    - `function()`: Serve images from WEB_DIR/images. [src/debriddo/main.py, 280-282]
      - description: Maps image path to WEB_DIR/images and returns FileResponse.
      - input: file_path
      - output: response: FileResponse, image asset

- Feature: Manifest endpoints
  - Component: src/debriddo/main.py
    - `configure()`: Build site.webmanifest JSON response. [src/debriddo/main.py, 286-315]
      - description: Constructs PWA manifest dict using app metadata and app_website URLs.
      - input: None
      - output: menifest_dict: dict, web manifest payload
    - `get_manifest()`: Build Stremio add-on manifest JSON. [src/debriddo/main.py, 321-395]
      - description: Constructs manifest with stream/meta resources and icon URLs derived from app_website.
      - input: None
      - output: manifest_dict: dict, add-on manifest payload

- Feature: Stream endpoint orchestration (GET /{config_url}/stream/{stream_type}/{stream_id})
  - Component: src/debriddo/main.py
    - `get_results()`: Orchestrate metadata lookup, search, filtering, and stream formatting. [src/debriddo/main.py, 408-505]
      - description: Decodes config, fetches metadata (returns 500 on missing metadata), loads cached/search results, filters and converts torrents, updates availability, formats Stremio streams, and returns streams list when debrid is enabled.
      - input: config_url; stream_type; stream_id; request
      - output: stream_list: list, Stremio stream entries; None: None, no response when debrid disabled
      - calls:
        - `parse_config()`: Decode compressed config payload. [src/debriddo/utils/parse_config.py, 8-13]
          - description: Decompresses URL-safe LZString config with C_ prefix and returns JSON dict.
          - input: encoded_config
          - output: config
          - calls:
            - `decode_lzstring()`: Decode LZString payload with tag prefix validation. [src/debriddo/utils/string_encoding.py, 24-38]
              - description: Strips tag prefix, decompresses URI component, and loads JSON payload.
              - input: data; tag
              - output: json_value
        - `TMDB.get_metadata()`: Fetch metadata from TMDB per language. [src/debriddo/metdata/tmdb.py, 14-53]
          - description: Uses configured languages with fallback to English when empty, issues TMDB API calls, and builds Movie/Series with multilingual titles.
          - input: id; type
          - output: result
        - `Cinemeta.get_metadata()`: Fetch metadata from Cinemeta. [src/debriddo/metdata/cinemeta.py, 13-43]
          - description: Calls Cinemeta API and returns Movie/Series with English-only language list.
          - input: id; type
          - output: result
        - `get_debrid_service()`: Select debrid service implementation by config. [src/debriddo/debrid/get_debrid_service.py, 13-26]
          - description: Instantiates RealDebrid, AllDebrid, Premiumize, or TorBox based on config['service'].
          - input: config
          - output: debrid_service
        - `search_cache()`: Retrieve cached results from SQLite. [src/debriddo/utils/cache.py, 53-144]
          - description: Deletes expired rows, queries cached_items by media identity, and returns matching cache rows.
          - input: config; media
          - output: cache_items: list, cached row dicts; None: None, when no cache results
        - `SearchResult.from_cached_item()`: Convert cached row to SearchResult. [src/debriddo/search/search_result.py, 71-90]
          - description: Maps cached dict fields into SearchResult attributes and parses raw title.
          - input: cached_item
          - output: self
        - `filter_items()`: Apply filtering pipeline to SearchResult items. [src/debriddo/utils/filter_results.py, 241-281]
          - description: Filters series by episode pair, episode-range packs, and localized complete-season patterns first, then filters titles and applies configured filter instances in order.
          - input: items; media; config
          - output: items: list, filtered results
          - calls:
            - `filter_out_non_matching()`: Keep only matching season/episode, range-pack, or localized complete-season items for series requests. [src/debriddo/utils/filter_results.py, 196-222]
              - description: Applies OR logic over exact pair, range pack, complete-season labels, and parsed season/episode matches; excludes season-only labels without completion markers.
              - input: items; season; episode
              - output: filtered_items: list, matched items
              - calls:
                - `_match_season_episode_pair()`: Match explicit season/episode pair tokens in torrent raw title. [src/debriddo/utils/filter_results.py, 92-102]
                  - description: Detects `SnnEmm`, `Snn Emm`, and `Snn-Emm` forms for the requested pair.
                  - input: raw_title; numeric_season; numeric_episode
                  - output: True: bool, pair matched; False: bool, pair not matched
                - `_match_episode_range_pack()`: Match season range-pack tokens and verify episode containment. [src/debriddo/utils/filter_results.py, 75-89]
                  - description: Detects `SnnExx-Eyy`/`SnnExx-yy` variants (including space/dash forms) and returns true only when requested episode is inside the pack range.
                  - input: raw_title; numeric_season; numeric_episode
                  - output: True: bool, range matched; False: bool, range not matched
                - `_match_complete_season()`: Match localized complete-season naming patterns in torrent raw title. [src/debriddo/utils/filter_results.py, 50-72]
                  - description: Detects localized `<SeasonLabel> <season>` followed by localized `<CompleteLabel>` in the same language for the requested season.
                  - input: raw_title; numeric_season
                  - output: True: bool, complete season matched; False: bool, no complete season pattern
        - `SearchService.search()`: Execute engine searches and post-process results. [src/debriddo/search/search_service.py, 70-123]
          - description: Runs engine searches (multi-threaded if enabled), post-processes results, and returns SearchResult list.
          - input: media
          - output: results: list, post-processed SearchResult; None: None, when no results
        - `TorrentService.convert_and_process()`: Convert SearchResult list into TorrentItem list. [src/debriddo/torrent/torrent_service.py, 62-72]
          - description: Converts results to TorrentItem and processes magnet/torrent links concurrently.
          - input: results
          - output: torrent_items_result: list, TorrentItem list
        - `TorrentSmartContainer.get_hashes()`: Extract info hashes for availability checks. [src/debriddo/torrent/torrent_smart_container.py, 26-27]
          - description: Returns list of info_hash keys from the internal items dict.
          - input: None
          - output: hashes: list, info_hash values
        - `TorrentSmartContainer.update_availability()`: Update availability for debrid services. [src/debriddo/torrent/torrent_smart_container.py, 67-77]
          - description: Dispatches availability update to service-specific handlers based on debrid service type.
          - input: debrid_response; debrid_type; media
          - output: None
        - `TorrentSmartContainer.cache_container_items()`: Persist torrent items to cache. [src/debriddo/torrent/torrent_smart_container.py, 56-61]
          - description: Saves public torrent items to SQLite cache via cache_results.
          - input: None
          - output: None
        - `TorrentSmartContainer.get_best_matching()`: Select best matching torrent items. [src/debriddo/torrent/torrent_smart_container.py, 38-54]
          - description: Keeps all magnet-only items and torrent-download items with file_index for matching.
          - input: None
          - output: best_matching: list, TorrentItem list
        - `sort_items()`: Sort torrent items according to config. [src/debriddo/utils/filter_results.py, 233-237]
          - description: Applies RTN-based sorting when config['sort'] is set.
          - input: items; config
          - output: items: list, sorted items
        - `parse_to_stremio_streams()`: Convert TorrentItem list to Stremio stream entries. [src/debriddo/utils/stremio_parser.py, 158-183]
          - description: Builds stream entries via threaded parse_to_debrid_stream and sorts by availability/type.
          - input: torrent_items; config; config_url; node_url; media
          - output: stream_list: list, Stremio stream dicts

- Feature: Configuration encoding and normalization helpers
  - Component: src/debriddo/utils/parse_config.py
    - `parse_config()`: Decode compressed config payload. [src/debriddo/utils/parse_config.py, 8-13]
      - description: Decompresses URL-safe config using decode_lzstring with C_ prefix and returns dict.
      - input: encoded_config
      - output: config
      - calls:
        - `decode_lzstring()`: Decode LZString payload with tag prefix validation. [src/debriddo/utils/string_encoding.py, 24-38]
          - description: Strips tag prefix, decompresses URI component, and loads JSON payload.
          - input: data; tag
          - output: json_value
    - `parse_query()`: Decode compressed playback query payload. [src/debriddo/utils/parse_config.py, 17-22]
      - description: Decompresses URL-safe query using decode_lzstring with Q_ prefix and returns dict.
      - input: encoded_query
      - output: query
      - calls:
        - `decode_lzstring()`: Decode LZString payload with tag prefix validation. [src/debriddo/utils/string_encoding.py, 24-38]
          - description: Strips tag prefix, decompresses URI component, and loads JSON payload.
          - input: data; tag
          - output: json_value
    - `encode_query()`: Encode playback query payload. [src/debriddo/utils/parse_config.py, 25-30]
      - description: Compresses query dict into URL-safe LZString payload with Q_ prefix.
      - input: query
      - output: encoded_query
      - calls:
        - `encode_lzstring()`: Encode JSON payload into LZString with tag prefix. [src/debriddo/utils/string_encoding.py, 11-21]
          - description: Serializes JSON and compresses with LZString URI component encoding.
          - input: json_value; tag
          - output: data
  - Component: src/debriddo/utils/string_encoding.py
    - `normalize()`: Normalize strings for search and cache keys. [src/debriddo/utils/string_encoding.py, 40-49]
      - description: Transliterates to ASCII, strips punctuation, collapses spaces, and lowercases.
      - input: string
      - output: string

- Feature: Metadata providers
  - Component: src/debriddo/metdata/metadata_provider_base.py
    - `replace_weird_characters()`: Normalize non-ASCII characters in titles. [src/debriddo/metdata/metadata_provider_base.py, 14-36]
      - description: Replaces accented and special characters using a fixed transliteration map.
      - input: string
      - output: string
  - Component: src/debriddo/metdata/cinemeta.py
    - `get_metadata()`: Retrieve metadata from Cinemeta API. [src/debriddo/metdata/cinemeta.py, 13-43]
      - description: Sends HTTP GET to Cinemeta endpoint and builds Movie/Series objects with English language list.
      - input: id; type
      - output: result
      - calls:
        - `request_get()`: Issue HTTP GET with AsyncThreadSafeSession headers. [src/debriddo/utils/async_httpx_session.py, 124-125]
          - description: Wraps request() to perform HTTP GET via httpx client.
          - input: url; kwargs
          - output: response; None: None, on error
          - calls:
            - `request()`: Core HTTP request wrapper with error handling. [src/debriddo/utils/async_httpx_session.py, 98-122]
              - description: Executes async HTTPX request with default headers/timeout and returns response or None on errors.
              - input: method; url; kwargs
              - output: response; None: None, on HTTP or connection errors
        - `close()`: Close AsyncThreadSafeSession client. [src/debriddo/utils/async_httpx_session.py, 41-45]
          - description: Closes the underlying HTTPX client and marks session closed.
          - input: None
          - output: None
        - `replace_weird_characters()`: Normalize non-ASCII characters in titles. [src/debriddo/metdata/metadata_provider_base.py, 14-36]
          - description: Replaces accented and special characters using a fixed transliteration map.
          - input: string
          - output: string
  - Component: src/debriddo/metdata/tmdb.py
    - `get_metadata()`: Retrieve metadata from TMDB API. [src/debriddo/metdata/tmdb.py, 14-52]
      - description: Sends TMDB API requests for each configured language and accumulates translated titles.
      - input: id; type
      - output: result
      - calls:
        - `request_get()`: Issue HTTP GET with AsyncThreadSafeSession headers. [src/debriddo/utils/async_httpx_session.py, 124-125]
          - description: Wraps request() to perform HTTP GET via httpx client.
          - input: url; kwargs
          - output: response; None: None, on error
          - calls:
            - `request()`: Core HTTP request wrapper with error handling. [src/debriddo/utils/async_httpx_session.py, 98-122]
              - description: Executes async HTTPX request with default headers/timeout and returns response or None on errors.
              - input: method; url; kwargs
              - output: response; None: None, on HTTP or connection errors
        - `close()`: Close AsyncThreadSafeSession client. [src/debriddo/utils/async_httpx_session.py, 41-45]
          - description: Closes the underlying HTTPX client and marks session closed.
          - input: None
          - output: None
        - `replace_weird_characters()`: Normalize non-ASCII characters in titles. [src/debriddo/metdata/metadata_provider_base.py, 14-36]
          - description: Replaces accented and special characters using a fixed transliteration map.
          - input: string
          - output: string

- Feature: Torrent search pipeline
  - Component: src/debriddo/search/search_service.py
    - `search()`: Execute engine searches and post-process results. [src/debriddo/search/search_service.py, 70-123]
      - description: Runs engine searches (multi-threaded if enabled), post-processes results, and returns SearchResult list.
      - input: media
      - output: results: list, post-processed SearchResult; None: None, when no results
      - calls:
        - `__get_indexers()`: Build SearchIndexer list from config engines. [src/debriddo/search/search_service.py, 307-315]
          - description: Converts configured engine list into SearchIndexer instances for execution.
          - input: None
          - output: indexers: dict, engine_name to SearchIndexer
          - calls:
            - `__get_indexer_from_engines()`: Construct SearchIndexer objects from engine names. [src/debriddo/search/search_service.py, 318-355]
              - description: Instantiates each engine plugin and resolves supported categories for movies/TV.
              - input: engines
              - output: indexer_list: list, SearchIndexer list
              - calls:
                - `__get_engine()`: Map engine name to plugin implementation. [src/debriddo/search/search_service.py, 126-146]
                  - description: Returns plugin class instance based on engine_name.
                  - input: engine_name
                  - output: engine
        - `__search_movie_indexer()`: Query an indexer for movie torrents. [src/debriddo/search/search_service.py, 149-208]
          - description: Builds a primary title/year query with optional language tag, executes fallback title search when primary yields no results, and gathers torrent dicts from plugin search.
          - input: movie; indexer
          - output: results: list, SearchResult list
          - calls:
            - `__get_torrents_from_list_of_dicts()`: Convert plugin dictionaries to SearchResult objects. [src/debriddo/search/search_service.py, 358-384]
              - description: Maps torrent dict fields into SearchResult instances while filtering seedless results.
              - input: media; indexer; list_of_dicts
              - output: result_list: list, SearchResult list
        - `__search_series_indexer()`: Query an indexer for series torrents. [src/debriddo/search/search_service.py, 211-304]
          - description: Executes episode, season-prefixed pack, and season (localized label) searches per language, runs fallback title search only when primaries are empty, and gathers torrent dicts from plugin search.
          - input: series; indexer
          - output: results: list, SearchResult list
          - calls:
            - `__get_torrents_from_list_of_dicts()`: Convert plugin dictionaries to SearchResult objects. [src/debriddo/search/search_service.py, 358-384]
              - description: Maps torrent dict fields into SearchResult instances while filtering seedless results.
              - input: media; indexer; list_of_dicts
              - output: result_list: list, SearchResult list
        - `__post_process_result()`: Normalize and enrich SearchResult after search. [src/debriddo/search/search_service.py, 408-434]
          - description: Ensures magnet availability, parses RTN metadata, detects languages, and extracts info hash.
          - input: indexers; result; media
          - output: result; None: None, when magnet retrieval fails
          - calls:
            - `__is_magnet_link()`: Detect magnet URLs. [src/debriddo/search/search_service.py, 387-389]
              - description: Returns True when link starts with magnet:? prefix.
              - input: link
              - output: True: bool, magnet link; False: bool, non-magnet link
            - `__extract_info_hash()`: Extract info hash from magnet link. [src/debriddo/search/search_service.py, 392-405]
              - description: Parses magnet xt parameter and returns hash or raises on invalid link.
              - input: magnet_link
              - output: info_hash
            - `detect_languages()`: Detect torrent languages by regex. [src/debriddo/utils/detection.py, 7-31]
              - description: Applies language regex patterns and returns detected codes or ["en"] fallback.
              - input: torrent_name
              - output: languages: list, language codes

- Feature: Filtering and sorting
  - Component: src/debriddo/utils/filter_results.py
    - `filter_items()`: Apply configured filters in order. [src/debriddo/utils/filter_results.py, 241-281]
      - description: Filters by season/episode pair, episode-range packs, and localized complete-season patterns first, then filters by title similarity and applies configured filters sequentially.
      - input: items; media; config
      - output: items: list, filtered SearchResult list
      - calls:
        - `filter_out_non_matching()`: Remove non-matching series items while preserving valid pair/range/complete-season matches. [src/debriddo/utils/filter_results.py, 196-222]
          - description: Applies OR matching over exact episode pair, pack ranges including the requested episode, localized complete-season markers, and parsed season/episode match.
          - input: items; season; episode
          - output: filtered_items: list, matched items
          - calls:
            - `_match_season_episode_pair()`: Match explicit season/episode pair tokens in torrent raw title. [src/debriddo/utils/filter_results.py, 92-102]
              - description: Matches the requested pair in `SnnEmm`, `Snn Emm`, and `Snn-Emm` forms.
              - input: raw_title; numeric_season; numeric_episode
              - output: True: bool, pair matched; False: bool, no pair match
            - `_match_episode_range_pack()`: Match range-pack tokens and validate requested-episode inclusion. [src/debriddo/utils/filter_results.py, 75-89]
              - description: Matches `SnnExx-Eyy` and `SnnExx-yy` forms (including space/dash variants) and validates `xx <= episode <= yy`.
              - input: raw_title; numeric_season; numeric_episode
              - output: True: bool, range matched; False: bool, no range match
            - `_match_complete_season()`: Match localized complete-season naming patterns in torrent raw title. [src/debriddo/utils/filter_results.py, 50-72]
              - description: Matches `<SeasonLabel> <season> ... <CompleteLabel>` only when both labels belong to the same localized language pair.
              - input: raw_title; numeric_season
              - output: True: bool, complete season matched; False: bool, no complete season pattern
        - `remove_non_matching_title()`: Filter by title similarity. [src/debriddo/utils/filter_results.py, 225-238]
          - description: Uses RTN title_match with threshold 0.5 to retain matching titles.
          - input: items; titles
          - output: filtered_items: list, matched items
        - `LanguageFilter.filter()`: Filter items by language selection. [src/debriddo/utils/filter/language_filter.py, 15-28]
          - description: Keeps items matching configured languages or multi-language items.
          - input: data
          - output: filtered_data: list, language-matched items
        - `MaxSizeFilter.filter()`: Filter items by max size. [src/debriddo/utils/filter/max_size_filter.py, 15-20]
          - description: Keeps items with size <= maxSize GB for movie types.
          - input: data
          - output: filtered_data: list, size-filtered items
        - `TitleExclusionFilter.filter()`: Exclude items by title keywords. [src/debriddo/utils/filter/title_exclusion_filter.py, 15-24]
          - description: Removes items containing excluded keywords in title.
          - input: data
          - output: filtered_items: list, filtered items
        - `QualityExclusionFilter.filter()`: Exclude items by quality. [src/debriddo/utils/filter/quality_exclusion_filter.py, 18-36]
          - description: Skips items whose parsed quality or category matches exclusion list.
          - input: data
          - output: filtered_items: list, filtered items
        - `ResultsPerQualityFilter.filter()`: Limit items per quality bucket. [src/debriddo/utils/filter/results_per_quality_filter.py, 15-29]
          - description: Retains up to resultsPerQuality items per resolution value.
          - input: data
          - output: filtered_items: list, filtered items
    - `sort_items()`: Sort items based on config setting. [src/debriddo/utils/filter_results.py, 284-288]
      - description: Delegates to items_sort when config['sort'] is set, otherwise returns items unchanged.
      - input: items; config
      - output: items: list, sorted items
      - calls:
        - `items_sort()`: Apply RTN ranking and sort criteria. [src/debriddo/utils/filter_results.py, 78-128]
          - description: Ranks torrents with RTN, assigns parsed_data, and sorts by quality/size criteria.
          - input: items; config
          - output: items: list, sorted items
          - calls:
            - `sort_quality()`: Compute sort key by resolution. [src/debriddo/utils/filter_results.py, 56-75]
              - description: Returns quality order or infinity when resolution is missing.
              - input: item
              - output: quality_key: tuple, (rank, missing_flag)

- Feature: Torrent processing and availability
  - Component: src/debriddo/torrent/torrent_service.py
    - `convert_and_process()`: Convert SearchResult list into processed TorrentItem list. [src/debriddo/torrent/torrent_service.py, 62-72]
      - description: Converts results to TorrentItem and processes web URLs or magnet links concurrently.
      - input: results
      - output: torrent_items_result: list, TorrentItem list
      - calls:
        - `__process_web_url_or_process_magnet()`: Route torrent processing by link type. [src/debriddo/torrent/torrent_service.py, 52-59]
          - description: Converts SearchResult to TorrentItem, then processes magnet or torrent URL.
          - input: result
          - output: torrent_item
          - calls:
            - `__process_magnet()`: Populate hash and trackers from magnet. [src/debriddo/torrent/torrent_service.py, 127-136]
              - description: Extracts info_hash and tracker list from magnet when missing.
              - input: result
              - output: result
              - calls:
                - `get_info_hash_from_magnet()`: Extract info hash from magnet string. [src/debriddo/utils/general.py, 25-38]
                  - description: Parses xt parameter to return lowercased info hash.
                  - input: magnet
                  - output: info_hash
                - `__get_trackers_from_magnet()`: Parse trackers from magnet query string. [src/debriddo/torrent/torrent_service.py, 174-182]
                  - description: Extracts tracker list from magnet URL query params.
                  - input: magnet
                  - output: trackers: list, tracker URLs
            - `__process_web_url()`: Download and parse torrent file URL. [src/debriddo/torrent/torrent_service.py, 75-96]
              - description: Downloads torrent content via AsyncThreadSafeSession and processes torrent metadata.
              - input: result
              - output: result; None: None, on failure
              - calls:
                - `request_get()`: Issue HTTP GET with AsyncThreadSafeSession headers. [src/debriddo/utils/async_httpx_session.py, 124-125]
                  - description: Wraps request() to perform HTTP GET via httpx client.
                  - input: url; kwargs
                  - output: response; None: None, on error
                - `close()`: Close AsyncThreadSafeSession client. [src/debriddo/utils/async_httpx_session.py, 41-45]
                  - description: Closes the underlying HTTPX client and marks session closed.
                  - input: None
                  - output: None
                - `__process_torrent()`: Parse torrent metadata and select file. [src/debriddo/torrent/torrent_service.py, 99-125]
                  - description: Decodes torrent file, builds magnet, selects file index, and updates TorrentItem fields.
                  - input: result; torrent_file
                  - output: result
    - `__process_torrent()`: Parse torrent metadata and select file. [src/debriddo/torrent/torrent_service.py, 99-125]
      - description: Builds magnet and info hash, sets trackers, selects movie/series file index and updates size/name.
      - input: result; torrent_file
      - output: result
      - calls:
        - `__get_trackers_from_torrent()`: Extract tracker URLs from torrent metadata. [src/debriddo/torrent/torrent_service.py, 152-172]
          - description: Normalizes announce/announce-list into unique tracker list.
          - input: torrent_metadata
          - output: trackers: list, tracker URLs
        - `__convert_torrent_to_hash()`: Compute info hash from torrent info. [src/debriddo/torrent/torrent_service.py, 138-141]
          - description: Bencodes info dict and returns SHA1 hex digest.
          - input: torrent_contents
          - output: hexHash
        - `__build_magnet()`: Build magnet URI from hash and trackers. [src/debriddo/torrent/torrent_service.py, 143-150]
          - description: Formats magnet URI with display name and tracker parameters.
          - input: hash; display_name; trackers
          - output: magnet
        - `__find_episode_file()`: Choose series episode file by season/episode. [src/debriddo/torrent/torrent_service.py, 184-207]
          - description: Parses filenames with RTN and returns largest matching episode file.
          - input: file_structure; season; episode
          - output: file_details
        - `__find_movie_file()`: Choose largest movie file from torrent. [src/debriddo/torrent/torrent_service.py, 209-219]
          - description: Picks the largest file by size to serve for movies.
          - input: file_structure
          - output: max_file_index
  - Component: src/debriddo/torrent/torrent_smart_container.py
    - `update_availability()`: Dispatch availability update by service type. [src/debriddo/torrent/torrent_smart_container.py, 67-77]
      - description: Routes availability response to RealDebrid, AllDebrid, Premiumize, or TorBox handlers.
      - input: debrid_response; debrid_type; media
      - output: None
      - calls:
        - `__update_availability_realdebrid()`: Update availability from RealDebrid response. [src/debriddo/torrent/torrent_smart_container.py, 79-115]
          - description: Matches selected files, updates file details when season/episode match.
          - input: response; media
          - output: None
          - calls:
            - `season_episode_in_filename()`: Match season/episode against filename. [src/debriddo/utils/general.py, 18-22]
              - description: Parses filename with RTN and checks season/episode membership.
              - input: filename; season; episode
              - output: True: bool, matches; False: bool, no match
            - `__update_file_details()`: Update TorrentItem fields from file list. [src/debriddo/torrent/torrent_smart_container.py, 164-172]
              - description: Sets availability, file_index, file_name, and size from largest file entry.
              - input: torrent_item; files
              - output: None
        - `__update_availability_alldebrid()`: Update availability from AllDebrid response. [src/debriddo/torrent/torrent_smart_container.py, 117-133]
          - description: Traverses AllDebrid file tree and updates file details for matching items.
          - input: response; media
          - output: None
          - calls:
            - `__explore_folders()`: Traverse file tree and collect matching files. [src/debriddo/torrent/torrent_smart_container.py, 186-231]
              - description: Recursively traverses folder structures and captures matching file entries.
              - input: folder; files; file_index; type; season; episode
              - output: file_index
            - `__update_file_details()`: Update TorrentItem fields from file list. [src/debriddo/torrent/torrent_smart_container.py, 164-172]
              - description: Sets availability, file_index, file_name, and size from largest file entry.
              - input: torrent_item; files
              - output: None
        - `__update_availability_torbox()`: Update availability from TorBox response. [src/debriddo/torrent/torrent_smart_container.py, 134-152]
          - description: Traverses TorBox file list and updates matching items.
          - input: response; media
          - output: None
          - calls:
            - `__explore_folders()`: Traverse file tree and collect matching files. [src/debriddo/torrent/torrent_smart_container.py, 186-231]
              - description: Recursively traverses folder structures and captures matching file entries.
              - input: folder; files; file_index; type; season; episode
              - output: file_index
            - `__update_file_details()`: Update TorrentItem fields from file list. [src/debriddo/torrent/torrent_smart_container.py, 164-172]
              - description: Sets availability, file_index, file_name, and size from largest file entry.
              - input: torrent_item; files
              - output: None
        - `__update_availability_premiumize()`: Update availability from Premiumize response. [src/debriddo/torrent/torrent_smart_container.py, 153-162]
          - description: Marks availability based on Premiumize response arrays.
          - input: response
          - output: None
    - `cache_container_items()`: Persist torrent items to cache. [src/debriddo/torrent/torrent_smart_container.py, 56-61]
      - description: Filters public items and writes them to SQLite cache via cache_results.
      - input: None
      - output: None
      - calls:
        - `__save_to_cache()`: Filter public torrents and call cache_results. [src/debriddo/torrent/torrent_smart_container.py, 63-66]
          - description: Filters items by privacy=="public" and delegates persistence.
          - input: None
          - output: None
          - calls:
            - `cache_results()`: Insert torrents into SQLite cache. [src/debriddo/utils/cache.py, 147-298]
              - description: Ensures cache DB/table exist, prepares cache item rows, and inserts them into cached_items.
              - input: torrents; media
              - output: None

- Feature: Stream formatting
  - Component: src/debriddo/utils/stremio_parser.py
    - `parse_to_stremio_streams()`: Convert TorrentItems to Stremio stream list. [src/debriddo/utils/stremio_parser.py, 160-185]
      - description: Spawns threads to create stream items, collects results, and sorts by availability/type.
      - input: torrent_items: List[TorrentItem]; config; config_url; node_url; media
      - output: stream_list: list, Stremio stream dicts
      - calls:
        - `parse_to_debrid_stream()`: Build stream entries for Debrid and direct torrent. [src/debriddo/utils/stremio_parser.py, 54-157]
          - description: Formats stream name/description using RTN ParsedData (legacy `.data` wrapper supported), builds playback URL or infoHash entry, and enqueues results.
          - input: torrent_item: TorrentItem; config_url; node_url; playtorrent; results: queue.Queue; media: Media
          - output: item: dict, stream entry
          - calls:
            - `get_emoji()`: Map language code to emoji. [src/debriddo/utils/stremio_parser.py, 17-32]
              - description: Returns emoji flag or default for language code.
              - input: language
              - output: emoji
            - `encode_query()`: Encode playback query payload. [src/debriddo/utils/parse_config.py, 25-30]
              - description: Compresses query dict into URL-safe LZString payload with Q_ prefix.
              - input: query
              - output: encoded_query
              - calls:
                - `encode_lzstring()`: Encode JSON payload into LZString with tag prefix. [src/debriddo/utils/string_encoding.py, 11-21]
                  - description: Serializes JSON and compresses with LZString URI component encoding.
                  - input: json_value; tag
                  - output: data
            - `to_debrid_stream_query()`: Build playback query dict from TorrentItem. [src/debriddo/torrent/torrent_item.py, 41-49]
              - description: Builds dict with magnet, type, file_index, season/episode, and torrent_download info.
              - input: media: Media
              - output: query: dict, playback query
        - `filter_by_availability()`: Sort by instant availability. [src/debriddo/utils/stremio_parser.py, 40-44]
          - description: Returns 0 for instantly available items, 1 otherwise.
          - input: item
          - output: sort_key: int
        - `filter_by_direct_torrnet()`: Sort direct torrent entries last. [src/debriddo/utils/stremio_parser.py, 47-51]
          - description: Returns 1 for direct torrent entries, 0 otherwise.
          - input: item
          - output: sort_key: int

- Feature: Cache persistence
  - Component: src/debriddo/utils/cache.py
    - `search_cache()`: Query cached results from SQLite. [src/debriddo/utils/cache.py, 53-144]
      - description: Deletes expired rows, queries cached_items by media attributes, and returns matching rows.
      - input: config; media
      - output: cache_items: list, cached row dicts; None: None, no matches
      - calls:
        - `normalize()`: Normalize strings for search and cache keys. [src/debriddo/utils/string_encoding.py, 40-49]
          - description: Transliterates to ASCII, strips punctuation, collapses spaces, and lowercases.
          - input: string
          - output: string
    - `cache_results()`: Write torrent results to SQLite cache. [src/debriddo/utils/cache.py, 147-298]
      - description: Creates DB/table as needed, builds cache rows per language, and inserts into cached_items.
      - input: torrents; media
      - output: None
      - calls:
        - `normalize()`: Normalize strings for search and cache keys. [src/debriddo/utils/string_encoding.py, 40-49]
          - description: Transliterates to ASCII, strips punctuation, collapses spaces, and lowercases.
          - input: string
          - output: string

- Feature: Playback redirect (GET /playback/{config_url}/{query_string})
  - Component: src/debriddo/main.py
    - `get_playback()`: Resolve debrid stream link and redirect. [src/debriddo/main.py, 518-539]
      - description: Decodes config/query, resolves debrid stream link, and returns HTTP 301 redirect to resolved URL.
      - input: config_url; query_string; request
      - output: RedirectResponse: RedirectResponse, playback redirect
      - calls:
        - `parse_config()`: Decode compressed config payload. [src/debriddo/utils/parse_config.py, 8-13]
          - description: Decompresses URL-safe LZString config with C_ prefix and returns JSON dict.
          - input: encoded_config
          - output: config
        - `parse_query()`: Decode compressed playback query payload. [src/debriddo/utils/parse_config.py, 17-22]
          - description: Decompresses URL-safe query using decode_lzstring with Q_ prefix and returns dict.
          - input: encoded_query
          - output: query
        - `get_debrid_service()`: Select debrid service implementation by config. [src/debriddo/debrid/get_debrid_service.py, 13-26]
          - description: Instantiates RealDebrid, AllDebrid, Premiumize, or TorBox based on config['service'].
          - input: config
          - output: debrid_service
        - `get_stream_link()`: Resolve stream link for selected debrid service. [src/debriddo/debrid/base_debrid.py, 55-56]
          - description: Abstract method implemented by specific debrid services to return stream link.
          - input: query; ip
          - output: link

- Feature: Debrid service selection and clients
  - Component: src/debriddo/debrid/get_debrid_service.py
    - `get_debrid_service()`: Select debrid service implementation by config. [src/debriddo/debrid/get_debrid_service.py, 13-26]
      - description: Instantiates RealDebrid, AllDebrid, Premiumize, or TorBox based on config['service'].
      - input: config
      - output: debrid_service
  - Component: src/debriddo/debrid/base_debrid.py
    - `wait_for_ready_status_async_func()`: Poll readiness using async status function. [src/debriddo/debrid/base_debrid.py, 17-27]
      - description: Polls async status until timeout, returning True when ready.
      - input: check_status_func; timeout; interval
      - output: True: bool, ready; False: bool, timed out
    - `get_json_response()`: Fetch JSON via AsyncThreadSafeSession. [src/debriddo/debrid/base_debrid.py, 42-46]
      - description: Uses AsyncThreadSafeSession.get_json_response to fetch JSON and close session.
      - input: url; kwargs
      - output: ret
    - `download_torrent_file()`: Download torrent file bytes. [src/debriddo/debrid/base_debrid.py, 48-52]
      - description: Uses AsyncThreadSafeSession.download_torrent_file to fetch torrent bytes.
      - input: download_url
      - output: ret
  - Component: src/debriddo/debrid/realdebrid.py
    - `get_stream_link()`: Resolve RealDebrid stream URL. [src/debriddo/debrid/realdebrid.py, 97-156]
      - description: Checks cached torrents, adds magnet or torrent file when needed, selects file, waits for link, and unrestricts download link.
      - input: query; ip
      - output: download: str, resolved stream URL
      - calls:
        - `__get_cached_torrent_ids()`: List cached torrent IDs for hash. [src/debriddo/debrid/realdebrid.py, 158-169]
          - description: Fetches user torrents and filters by info hash.
          - input: info_hash
          - output: torrent_ids: list
        - `__get_cached_torrent_info()`: Resolve cached torrent info. [src/debriddo/debrid/realdebrid.py, 171-185]
          - description: Selects cached torrent info that contains requested file.
          - input: cached_ids; file_index; season; episode
          - output: cached_torrent_info
        - `__add_magnet_or_torrent()`: Add magnet or torrent file to RealDebrid. [src/debriddo/debrid/realdebrid.py, 201-229]
          - description: Adds magnet or torrent file and returns torrent info.
          - input: magnet; torrent_download
          - output: torrent_info
          - calls:
            - `add_magnet()`: Add magnet to RealDebrid. [src/debriddo/debrid/realdebrid.py, 26-29]
              - description: Calls RealDebrid addMagnet endpoint.
              - input: magnet; ip
              - output: response
            - `add_torrent()`: Upload torrent file to RealDebrid. [src/debriddo/debrid/realdebrid.py, 31-34]
              - description: Calls RealDebrid addTorrent endpoint.
              - input: torrent_file
              - output: response
        - `__select_file()`: Select torrent file for playback. [src/debriddo/debrid/realdebrid.py, 247-276]
          - description: Selects file by index or largest matching episode file.
          - input: torrent_info; stream_type; file_index; season; episode
          - output: None
        - `wait_for_link()`: Poll for ready download links. [src/debriddo/debrid/realdebrid.py, 73-81]
          - description: Polls torrent info until links are available or timeout expires.
          - input: torrent_id; timeout; interval
          - output: links; None: None, timeout
        - `unrestrict_link()`: Unrestrict RealDebrid link. [src/debriddo/debrid/realdebrid.py, 58-61]
          - description: Calls RealDebrid unrestrict endpoint to resolve download URL.
          - input: link
          - output: response
        - `__find_appropiate_link()`: Select appropriate link for requested file. [src/debriddo/debrid/realdebrid.py, 277-307]
          - description: Maps selected file index to download link and returns fallback NO_CACHE_VIDEO_URL when out of range.
          - input: torrent_info; links; file_index; season; episode
          - output: link
    - `get_availability_bulk()`: Query RealDebrid availability by hash. [src/debriddo/debrid/realdebrid.py, 83-95]
      - description: Looks up cached hashes and returns availability response.
      - input: hashes_or_magnets; ip
      - output: response
  - Component: src/debriddo/debrid/alldebrid.py
    - `get_stream_link()`: Resolve AllDebrid stream URL. [src/debriddo/debrid/alldebrid.py, 39-100]
      - description: Adds magnet/torrent, waits for readiness, selects matching file, and unlocks link.
      - input: query; ip
      - output: link: str, resolved stream URL
      - calls:
        - `__add_magnet_or_torrent()`: Add magnet or torrent to AllDebrid. [src/debriddo/debrid/alldebrid.py, 119-145]
          - description: Adds magnet or uploads torrent file and returns torrent ID.
          - input: magnet; torrent_download; ip
          - output: torrent_id
          - calls:
            - `add_magnet()`: Add magnet to AllDebrid. [src/debriddo/debrid/alldebrid.py, 22-24]
              - description: Calls AllDebrid magnet upload endpoint.
              - input: magnet; ip
              - output: response
            - `add_torrent()`: Upload torrent file to AllDebrid. [src/debriddo/debrid/alldebrid.py, 26-29]
              - description: Calls AllDebrid upload endpoint with multipart file.
              - input: torrent_file; ip
              - output: response
        - `check_magnet_status()`: Query AllDebrid magnet status. [src/debriddo/debrid/alldebrid.py, 31-33]
          - description: Retrieves magnet status details via AllDebrid API.
          - input: id; ip
          - output: response
        - `wait_for_ready_status_async_func()`: Poll readiness using async status function. [src/debriddo/debrid/base_debrid.py, 17-27]
          - description: Polls async status until timeout, returning True when ready.
          - input: check_status_func; timeout; interval
          - output: True: bool, ready; False: bool, timed out
        - `unrestrict_link()`: Unlock AllDebrid link. [src/debriddo/debrid/alldebrid.py, 35-37]
          - description: Calls AllDebrid link unlock endpoint.
          - input: link; ip
          - output: response
    - `get_availability_bulk()`: Query AllDebrid availability by hash. [src/debriddo/debrid/alldebrid.py, 102-117]
      - description: Reads AllDebrid magnet status and collects matching IDs.
      - input: hashes_or_magnets; ip
      - output: ids: list
  - Component: src/debriddo/debrid/premiumize.py
    - `get_stream_link()`: Resolve Premiumize stream URL. [src/debriddo/debrid/premiumize.py, 54-125]
      - description: Creates transfer, waits for cached availability, resolves file/folder details, and returns link.
      - input: query; ip
      - output: link: str, resolved stream URL
      - calls:
        - `add_magnet()`: Create Premiumize transfer for magnet. [src/debriddo/debrid/premiumize.py, 21-24]
          - description: Calls Premiumize transfer/create endpoint.
          - input: magnet; ip
          - output: response
        - `wait_for_ready_status_async_func()`: Poll readiness using async status function. [src/debriddo/debrid/base_debrid.py, 17-27]
          - description: Polls async status until timeout, returning True when ready.
          - input: check_status_func; timeout; interval
          - output: True: bool, ready; False: bool, timed out
        - `list_transfers()`: List active Premiumize transfers. [src/debriddo/debrid/premiumize.py, 32-34]
          - description: Calls Premiumize transfer/list endpoint.
          - input: None
          - output: response
        - `get_folder_or_file_details()`: Fetch file/folder details. [src/debriddo/debrid/premiumize.py, 36-43]
          - description: Calls Premiumize folder/list or item/details based on is_folder.
          - input: item_id; is_folder
          - output: response
        - `get_availability()`: Check cached availability for hash. [src/debriddo/debrid/premiumize.py, 45-47]
          - description: Calls Premiumize cache/check endpoint for hash.
          - input: hash
          - output: response
  - Component: src/debriddo/debrid/torbox.py
    - `get_stream_link()`: Resolve TorBox stream URL. [src/debriddo/debrid/torbox.py, 101-152]
      - description: Adds magnet, waits for cached files or polling, then selects largest matching file and requests download link.
      - input: query; ip
      - output: link: str, resolved stream URL
      - calls:
        - `add_magnet()`: Add magnet to TorBox. [src/debriddo/debrid/torbox.py, 42-68]
          - description: Calls TorBox createtorrent endpoint and returns torrent_id/hash metadata.
          - input: magnet
          - output: data
        - `check_magnet_status()`: Query TorBox cached status. [src/debriddo/debrid/torbox.py, 70-79]
          - description: Calls TorBox checkcached endpoint and returns data list.
          - input: torrent_hash
          - output: response
        - `wait_for_files()`: Poll TorBox for file availability. [src/debriddo/debrid/torbox.py, 26-40]
          - description: Polls check_magnet_status until files are available or timeout occurs.
          - input: torrent_hash; timeout; interval
          - output: files; None: None, timeout
        - `get_file_download_link()`: Request TorBox file download URL. [src/debriddo/debrid/torbox.py, 81-89]
          - description: Calls TorBox requestdl endpoint for selected file index.
          - input: torrent_id; file_name
          - output: response
    - `get_availability_bulk()`: Query TorBox availability by hash. [src/debriddo/debrid/torbox.py, 169-192]
      - description: Calls TorBox checkcached endpoint per hash and returns available torrent metadata.
      - input: hashes_or_magnets; ip
      - output: available_torrents: dict

- Feature: API tester CLI
  - Component: src/api_tester/api_tester.py
    - `main()`: Parse CLI and dispatch API test command. [src/api_tester/api_tester.py, 831-843]
      - description: Validates that no Debriddo modules are loaded, builds the parser, parses CLI args, and executes the selected command handler with error handling.
      - input: None
      - output: exit_code: int, CLI exit status
      - calls:
        - `ensure_no_debriddo_modules_loaded()`: Block execution when Debriddo modules are loaded. [src/api_tester/api_tester.py, 38-47]
          - description: Scans sys.modules for the debriddo namespace and raises CliError when found.
          - input: None
          - output: None
        - `build_parser()`: Configure argparse CLI and subcommands. [src/api_tester/api_tester.py, 675-829]
          - description: Declares CLI options and binds command handlers for target, stream, search, playback, and smoke tests.
          - input: None
          - output: parser: argparse.ArgumentParser, CLI parser with subcommands
        - `cmd_smoke()`: Execute the API smoke suite and report summary. [src/api_tester/api_tester.py, 660-672]
          - description: Resolves target URLs, runs the smoke workflow, prints PASS/FAIL results, and returns non-zero when failures occur.
          - input: args: argparse.Namespace
          - output: exit_code: int, 0 on success, 1 when failures exist
          - calls:
            - `get_target_from_args()`: Resolve configuration URL from CLI/env. [src/api_tester/api_tester.py, 101-107]
              - description: Reads --config-url or env var and normalizes the configuration URL.
              - input: args: argparse.Namespace
              - output: target: TargetUrls
              - calls:
                - `normalize_config_url()`: Validate and normalize config URL into target parts. [src/api_tester/api_tester.py, 64-98]
                  - description: Parses URL, extracts C_ segment, and builds base/config URLs.
                  - input: raw_value: str
                  - output: target: TargetUrls
            - `run_smoke()`: Run HTTP checks across core endpoints. [src/api_tester/api_tester.py, 444-657]
              - description: Issues HTTP requests to configuration, assets, manifest, stream, and playback endpoints and records per-check results.
              - input: args: argparse.Namespace; target: TargetUrls
              - output: results: list, CheckResult entries
              - calls:
                - `request_url()`: Issue HTTP request via requests.Session. [src/api_tester/api_tester.py, 110-125]
                  - description: Executes the HTTP request with timeout and SSL options and returns the response.
                  - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
                  - output: response: requests.Response
                - `request_stream()`: Request stream endpoint for a media item. [src/api_tester/api_tester.py, 265-287]
                  - description: Builds the stream URL, sends a GET request, and returns the response.
                  - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; stream_type: str; stream_id: str; append_json_suffix: bool
                  - output: response: requests.Response
                  - calls:
                    - `build_stream_path()`: Build stream endpoint path. [src/api_tester/api_tester.py, 188-197]
                      - description: Encodes stream ID, appends .json when requested, and builds the stream path.
                      - input: target: TargetUrls; stream_type: str; stream_id: str; append_json_suffix: bool
                      - output: path: str
                    - `request_url()`: Issue HTTP request via requests.Session. [src/api_tester/api_tester.py, 110-125]
                      - description: Executes the HTTP request with timeout and SSL options and returns the response.
                      - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
                      - output: response: requests.Response
                - `request_playback()`: Request playback endpoint. [src/api_tester/api_tester.py, 366-381]
                  - description: Builds playback URL and issues the HTTP request.
                  - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; method: str; playback_path: str
                  - output: response: requests.Response
                  - calls:
                    - `request_url()`: Issue HTTP request via requests.Session. [src/api_tester/api_tester.py, 110-125]
                      - description: Executes the HTTP request with timeout and SSL options and returns the response.
                      - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
                      - output: response: requests.Response
                - `validate_manifest_payload()`: Validate Stremio manifest payload. [src/api_tester/api_tester.py, 425-437]
                  - description: Confirms the manifest contains a stream resource supporting movie and series.
                  - input: payload: Dict[str, Any]
                  - output: ok: bool; detail: str
                - `extract_playback_path_from_streams()`: Extract playback path from stream payload. [src/api_tester/api_tester.py, 349-363]
                  - description: Scans stream entries for a playback URL and returns its path.
                  - input: streams_payload: Dict[str, Any]
                  - output: playback_path: str; None: None, when missing
                - `add_check()`: Append a smoke check result. [src/api_tester/api_tester.py, 440-441]
                  - description: Adds a CheckResult entry to the results list.
                  - input: results: List[CheckResult]; name: str; ok: bool; detail: str
                  - output: None

- Feature: Release workflow automation
  - Component: .github/workflows/release.yml
    - `create-release job()`: Build release assets and publish Docker images on tag push. [.github/workflows/release.yml, 13-103]
      - description: Runs on tag pushes, creates GitHub release, uploads zip asset, builds and pushes container images, and attests provenance.
      - input: github.ref_name; github.repository; env.REGISTRY; env.IMAGE_NAME
      - output: release_asset: zip; docker_images: tags; attestation: build provenance
      - calls:
        - `Checkout code()`: Pull repository contents. [.github/workflows/release.yml, 23-24]
          - description: Uses actions/checkout to fetch repository sources.
          - input: None
          - output: workspace
        - `Create GitHub Release()`: Publish GitHub release with changelog. [.github/workflows/release.yml, 26-36]
          - description: Uses softprops/action-gh-release to create release with CHANGELOG.md body.
          - input: github.ref_name; CHANGELOG.md
          - output: upload_url
        - `Download auto-generated ZIP()`: Download tag archive zip. [.github/workflows/release.yml, 38-39]
          - description: Uses curl to download GitHub tag zip archive.
          - input: github.ref_name; github.repository
          - output: zip_file
        - `Set repository name as output()`: Export repo name to env. [.github/workflows/release.yml, 41-45]
          - description: Extracts repo name and exports to GITHUB_ENV.
          - input: github.repository
          - output: env.repo_name
        - `Upload Asset on Release()`: Upload zip asset to release. [.github/workflows/release.yml, 47-55]
          - description: Uploads zip artifact to release using upload-release-asset.
          - input: upload_url; asset_path; asset_name
          - output: release_asset
        - `Convert repository name to lowercase()`: Normalize image name. [.github/workflows/release.yml, 59-61]
          - description: Sets IMAGE_NAME_LC in GITHUB_ENV.
          - input: IMAGE_NAME
          - output: env.IMAGE_NAME_LC
        - `Set up QEMU()`: Enable multi-arch builds. [.github/workflows/release.yml, 63-64]
          - description: Uses docker/setup-qemu-action to enable emulation.
          - input: None
          - output: qemu
        - `Set up Docker Buildx()`: Initialize buildx builder. [.github/workflows/release.yml, 66-67]
          - description: Uses docker/setup-buildx-action to configure builder.
          - input: None
          - output: buildx
        - `Log in to GitHub Container Registry()`: Authenticate to registry. [.github/workflows/release.yml, 69-75]
          - description: Uses docker/login-action to authenticate to ghcr.io.
          - input: env.REGISTRY; secrets.GITHUB_TOKEN
          - output: auth_session
        - `Extract metadata (tags, labels) for Docker()`: Generate Docker tags/labels. [.github/workflows/release.yml, 76-81]
          - description: Uses docker/metadata-action to produce tags and labels.
          - input: env.REGISTRY; env.IMAGE_NAME_LC
          - output: meta.outputs.labels
        - `Build and push Docker image()`: Build/push multi-arch images. [.github/workflows/release.yml, 82-93]
          - description: Uses docker/build-push-action to build and push images with tag and latest.
          - input: platforms; tags; labels
          - output: push.outputs.digest
        - `Generate artifact attestation()`: Attest build provenance. [.github/workflows/release.yml, 94-99]
          - description: Uses actions/attest-build-provenance to publish provenance.
          - input: subject-name; subject-digest
          - output: attestation
        - `Notify success()`: Emit success message. [.github/workflows/release.yml, 101-102]
          - description: Prints "Release created!" to workflow logs.
          - input: None
          - output: log_line

- Feature: API Tester startup, isolation guard, and command dispatch
  - Component: src/api_tester/api_tester.py
    - `main()`: Bootstrap CLI execution with isolation checks and controlled error codes. [src/api_tester/api_tester.py, 831-843]
      - description: Enforces anti-debriddo guard, builds parser, resolves subcommand dispatch through `args.func(args)`, and maps transport/input failures to exit code `2`.
      - input: None
      - output: int, process exit code
      - calls:
        - `ensure_no_debriddo_modules_loaded()`: Block execution when `debriddo` modules are loaded. [src/api_tester/api_tester.py, 38-47]
          - description: Scans `sys.modules` for `debriddo` namespace prefixes and raises `CliError` if any module is already loaded.
          - input: None
          - output: None
        - `build_parser()`: Build CLI arguments and bind subcommands to handlers. [src/api_tester/api_tester.py, 675-829]
          - description: Configures shared options (`--config-url`, `--timeout`, TLS/body flags) and binds `target/root/configure/manifest/site-webmanifest/asset/stream/search/playback/smoke` handlers.
          - input: None
          - output: parser: argparse.ArgumentParser, configured CLI parser

- Feature: Target normalization and URL construction common logic
  - Component: src/api_tester/api_tester.py
    - `get_target_from_args()`: Resolve config URL from CLI/env and normalize it. [src/api_tester/api_tester.py, 101-107]
      - description: Prioritizes `--config-url` over environment (`--config-url-env`), validates presence, and delegates parsing to normalized target derivation.
      - input: args: argparse.Namespace
      - output: TargetUrls, normalized `base_url/config_segment/config_url`
      - calls:
        - `normalize_config_url()`: Parse and validate Debriddo config URL format. [src/api_tester/api_tester.py, 64-98]
          - description: Validates scheme+host, strips trailing `manifest.json/configure`, finds first `C_` segment, and derives base/config URLs used by all commands.
          - input: raw_value: str
          - output: TargetUrls, normalized target tuple
    - `make_url()`: Compose absolute URL from base URL and relative path. [src/api_tester/api_tester.py, 128-129]
      - description: Normalizes slashes and returns final URL for HTTP requests.
      - input: base_url: str; path: str
      - output: str, absolute URL
    - `request_url()`: Execute HTTP request to target API endpoints. [src/api_tester/api_tester.py, 110-125]
      - description: Uses `requests.Session.request` with timeout/TLS/redirect controls; this is the primary external API boundary for API Tester.
      - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
      - output: requests.Response

- Feature: Endpoint probe commands and shared HTTP response formatting
  - Component: src/api_tester/api_tester.py
    - `cmd_root()`: Probe `GET /` endpoint without following redirects. [src/api_tester/api_tester.py, 208-218]
      - description: Resolves target and delegates request execution to common endpoint helper.
      - input: args: argparse.Namespace
      - output: int, command exit code
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `call_simple_endpoint()`: Execute request and print compact response summary. [src/api_tester/api_tester.py, 166-185]
          - description: Builds URL, performs request, prints `HTTP/Location/Content-Type` and optional body, and maps response status to `0/1`.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; path: str; method: str; allow_redirects: bool
          - output: int, `0` if response.ok else `1`
          - calls:
            - `make_url()`: Build endpoint URL from base/path. [src/api_tester/api_tester.py, 128-129]
              - description: Concatenates normalized path segments into final URL.
              - input: base_url: str; path: str
              - output: str, absolute URL
            - `request_url()`: Perform HTTP request. [src/api_tester/api_tester.py, 110-125]
              - description: Performs network call to Debriddo endpoint.
              - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
              - output: requests.Response
            - `print_response_summary()`: Print status/header/body summary. [src/api_tester/api_tester.py, 139-163]
              - description: Prints status and selected headers; when enabled, renders JSON/text body with max-length truncation.
              - input: response: requests.Response; print_body: bool; max_body_chars: int
              - output: None
              - calls:
                - `parse_json_body()`: Parse JSON body safely. [src/api_tester/api_tester.py, 132-136]
                  - description: Returns deserialized JSON payload or `None` on parse failure.
                  - input: response: requests.Response
                  - output: Optional[Any], parsed body
    - `cmd_configure()`: Probe configure endpoint with optional config prefix. [src/api_tester/api_tester.py, 221-225]
      - description: Chooses `/configure` or `/{config}/configure` then reuses common endpoint helper.
      - input: args: argparse.Namespace
      - output: int, command exit code
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `call_simple_endpoint()`: Execute request and summarize response. [src/api_tester/api_tester.py, 166-185]
          - description: Runs request and maps result to exit code.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; path: str; method: str; allow_redirects: bool
          - output: int
    - `cmd_manifest()`: Probe manifest endpoint with optional config prefix. [src/api_tester/api_tester.py, 228-232]
      - description: Chooses `/manifest.json` or `/{config}/manifest.json` and executes common probe flow.
      - input: args: argparse.Namespace
      - output: int, command exit code
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `call_simple_endpoint()`: Execute request and summarize response. [src/api_tester/api_tester.py, 166-185]
          - description: Runs request and maps result to exit code.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; path: str; method: str; allow_redirects: bool
          - output: int
    - `cmd_site_webmanifest()`: Probe `GET /site.webmanifest`. [src/api_tester/api_tester.py, 235-238]
      - description: Invokes fixed endpoint check using the common probe helper.
      - input: args: argparse.Namespace
      - output: int, command exit code
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `call_simple_endpoint()`: Execute request and summarize response. [src/api_tester/api_tester.py, 166-185]
          - description: Runs request and maps result to exit code.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; path: str; method: str; allow_redirects: bool
          - output: int
    - `cmd_asset()`: Probe static asset endpoints by asset type map. [src/api_tester/api_tester.py, 241-262]
      - description: Maps `asset-type` values to static paths, optionally prefixes `/{config}/` (except favicon), and executes request using common helper.
      - input: args: argparse.Namespace
      - output: int, command exit code
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `call_simple_endpoint()`: Execute request and summarize response. [src/api_tester/api_tester.py, 166-185]
          - description: Runs request and maps result to exit code.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; path: str; method: str; allow_redirects: bool
          - output: int

- Feature: Stream and playback command flow
  - Component: src/api_tester/api_tester.py
    - `cmd_stream()`: Probe stream endpoint and summarize returned stream items. [src/api_tester/api_tester.py, 290-315]
      - description: Calls stream endpoint for selected media type/id, prints response metadata, and outputs stream count plus key preview for first N entries.
      - input: args: argparse.Namespace
      - output: int, `0` on HTTP success else `1`
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `request_stream()`: Execute `GET /{config}/stream/{type}/{id}`. [src/api_tester/api_tester.py, 265-287]
          - description: Builds stream path with optional `.json` suffix and executes HTTP request.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; stream_type: str; stream_id: str; append_json_suffix: bool
          - output: requests.Response
          - calls:
            - `build_stream_path()`: Build encoded stream path from media identifiers. [src/api_tester/api_tester.py, 188-197]
              - description: URL-encodes stream ID, appends `.json` when requested, and returns path with config token.
              - input: target: TargetUrls; stream_type: str; stream_id: str; append_json_suffix: bool
              - output: str, stream endpoint path
            - `make_url()`: Build endpoint URL from base/path. [src/api_tester/api_tester.py, 128-129]
              - description: Concatenates normalized path segments into final URL.
              - input: base_url: str; path: str
              - output: str, absolute URL
            - `request_url()`: Perform HTTP request. [src/api_tester/api_tester.py, 110-125]
              - description: Performs network call to Debriddo endpoint.
              - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
              - output: requests.Response
        - `print_response_summary()`: Print status/header/body summary. [src/api_tester/api_tester.py, 139-163]
          - description: Prints status/header metadata and optional parsed response body.
          - input: response: requests.Response; print_body: bool; max_body_chars: int
          - output: None
        - `parse_json_body()`: Parse JSON body safely. [src/api_tester/api_tester.py, 132-136]
          - description: Returns parsed dict/list payload when response contains JSON.
          - input: response: requests.Response
          - output: Optional[Any], parsed body
    - `cmd_search()`: Fetch stream payload and print full stream entries. [src/api_tester/api_tester.py, 318-346]
      - description: Calls stream endpoint for selected media, prints response metadata, then emits each stream item as full JSON payload with index.
      - input: args: argparse.Namespace
      - output: int, `0` on HTTP success else `1`
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `request_stream()`: Execute `GET /{config}/stream/{type}/{id}`. [src/api_tester/api_tester.py, 265-287]
          - description: Builds stream path with optional `.json` suffix and executes HTTP request.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; stream_type: str; stream_id: str; append_json_suffix: bool
          - output: requests.Response
          - calls:
            - `build_stream_path()`: Build encoded stream path from media identifiers. [src/api_tester/api_tester.py, 188-197]
              - description: URL-encodes stream ID, appends `.json` when requested, and returns path with config token.
              - input: target: TargetUrls; stream_type: str; stream_id: str; append_json_suffix: bool
              - output: str, stream endpoint path
            - `make_url()`: Build endpoint URL from base/path. [src/api_tester/api_tester.py, 128-129]
              - description: Concatenates normalized path segments into final URL.
              - input: base_url: str; path: str
              - output: str, absolute URL
            - `request_url()`: Perform HTTP request. [src/api_tester/api_tester.py, 110-125]
              - description: Performs network call to Debriddo endpoint.
              - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
              - output: requests.Response
        - `print_response_summary()`: Print status/header/body summary. [src/api_tester/api_tester.py, 139-163]
          - description: Prints status/header metadata and optional parsed response body.
          - input: response: requests.Response; print_body: bool; max_body_chars: int
          - output: None
        - `parse_json_body()`: Parse JSON body safely. [src/api_tester/api_tester.py, 132-136]
          - description: Returns parsed dict/list payload when response contains JSON.
          - input: response: requests.Response
          - output: Optional[Any], parsed body
    - `cmd_playback()`: Probe playback endpoint by direct query or stream-derived playback path. [src/api_tester/api_tester.py, 384-422]
      - description: Uses explicit `--query` or discovers playback URL from stream payload, chooses `GET`/`HEAD`, and reports HTTP summary.
      - input: args: argparse.Namespace
      - output: int, `0` when status `<400` else `1`
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `request_stream()`: Execute stream request for playback URL discovery. [src/api_tester/api_tester.py, 265-287]
          - description: Fetches stream payload when query argument is omitted.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; stream_type: str; stream_id: str; append_json_suffix: bool
          - output: requests.Response
        - `parse_json_body()`: Parse JSON body safely. [src/api_tester/api_tester.py, 132-136]
          - description: Deserializes stream payload to inspect `streams`.
          - input: response: requests.Response
          - output: Optional[Any], parsed body
        - `extract_playback_path_from_streams()`: Select first playback URL path from stream list. [src/api_tester/api_tester.py, 349-363]
          - description: Iterates stream items and returns first path containing `/playback/`; returns `None` when absent.
          - input: streams_payload: Dict[str, Any]
          - output: Optional[str], playback path
        - `request_playback()`: Execute playback request with selected HTTP method. [src/api_tester/api_tester.py, 366-381]
          - description: Builds playback URL and performs request without following redirects.
          - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; method: str; playback_path: str
          - output: requests.Response
          - calls:
            - `make_url()`: Build endpoint URL from base/path. [src/api_tester/api_tester.py, 128-129]
              - description: Concatenates normalized path segments into final URL.
              - input: base_url: str; path: str
              - output: str, absolute URL
            - `request_url()`: Perform HTTP request. [src/api_tester/api_tester.py, 110-125]
              - description: Performs network call to Debriddo endpoint.
              - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
              - output: requests.Response
        - `print_response_summary()`: Print status/header/body summary. [src/api_tester/api_tester.py, 139-163]
          - description: Prints status/header metadata and optional parsed response body.
          - input: response: requests.Response; print_body: bool; max_body_chars: int
          - output: None

- Feature: Smoke suite orchestration and structured PASS/FAIL output
  - Component: src/api_tester/api_tester.py
    - `cmd_smoke()`: Execute integrated smoke checks and return aggregated status. [src/api_tester/api_tester.py, 660-672]
      - description: Resolves target, executes smoke pipeline, prints one line per check with `[PASS|FAIL]`, and returns non-zero when failures exist.
      - input: args: argparse.Namespace
      - output: int, `0` when no failures else `1`
      - calls:
        - `get_target_from_args()`: Resolve normalized target. [src/api_tester/api_tester.py, 101-107]
          - description: Resolves and validates target URL from CLI/env.
          - input: args: argparse.Namespace
          - output: TargetUrls
        - `run_smoke()`: Execute multi-endpoint smoke checks. [src/api_tester/api_tester.py, 444-657]
          - description: Probes root/configure/assets/site webmanifest/manifest/stream/playback endpoints and records each check as `CheckResult`.
          - input: args: argparse.Namespace; target: TargetUrls
          - output: List[CheckResult], ordered smoke results
          - calls:
            - `request_url()`: Perform HTTP request for each checked endpoint. [src/api_tester/api_tester.py, 110-125]
              - description: Calls external Debriddo HTTP API boundary with command-level timeout/TLS options.
              - input: session: requests.Session; method: str; url: str; timeout: float; verify_ssl: bool; allow_redirects: bool
              - output: requests.Response
            - `make_url()`: Compose endpoint URLs for smoke checks. [src/api_tester/api_tester.py, 128-129]
              - description: Converts base URL plus per-check paths into executable request URLs.
              - input: base_url: str; path: str
              - output: str, absolute URL
            - `add_check()`: Append check outcome record. [src/api_tester/api_tester.py, 440-441]
              - description: Appends immutable status tuple to shared result list.
              - input: results: List[CheckResult]; name: str; ok: bool; detail: str
              - output: None
            - `parse_json_body()`: Parse manifest/stream payloads for semantic checks. [src/api_tester/api_tester.py, 132-136]
              - description: Converts JSON bodies for structural validations (`resources`, `streams`).
              - input: response: requests.Response
              - output: Optional[Any], parsed body
            - `validate_manifest_payload()`: Validate Stremio manifest stream resource fields. [src/api_tester/api_tester.py, 425-437]
              - description: Asserts manifest contains `resources` list and a `stream` resource supporting `movie` and `series`.
              - input: payload: Dict[str, Any]
              - output: Tuple[bool, str], validation flag and detail
            - `request_stream()`: Probe movie/series stream endpoints inside smoke flow. [src/api_tester/api_tester.py, 265-287]
              - description: Fetches stream payloads used for stream checks and playback discovery.
              - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; stream_type: str; stream_id: str; append_json_suffix: bool
              - output: requests.Response
            - `extract_playback_path_from_streams()`: Extract playback URL path from movie stream payload. [src/api_tester/api_tester.py, 349-363]
              - description: Searches stream entries for first path containing `/playback/`.
              - input: streams_payload: Dict[str, Any]
              - output: Optional[str], playback path
            - `request_playback()`: Probe playback endpoints with `GET` and `HEAD`. [src/api_tester/api_tester.py, 366-381]
              - description: Executes playback URL checks for redirect and known HEAD behavior.
              - input: session: requests.Session; args: argparse.Namespace; target: TargetUrls; method: str; playback_path: str
              - output: requests.Response
